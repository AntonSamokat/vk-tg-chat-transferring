# vk-tg-chat-transferring

Bring your vk chat history – including videos and documents – to Telegram.
https://core.telegram.org/api/import

Приложение позволяет перенести все сообщения выбранной беседы из vk в telegram

## Инструкция по переносу беседы

### 0. Подготовка

0. Склонируйте репозиторий
1. Получите доступ к api
    1. **vk**. [Получите](https://vkhost.github.io/) id приложения (API_ID) с доступом
       к [messages](https://dev.vk.com/reference/access-rights)
    2. **telegram**. Получите API_ID и API_HASH, заполнив форму на официальном сайте https://my.telegram.org/apps
2. Запишите эти ключи в env файл
    1. `cp env.example env`
    2. Укажите в нём полученные `VK_API_ID`, `TG_API_ID`, `TG_API_HASH`
3. Установите `ffmpeg`. Его использует библиотека youtube-dl, с помощью которой из беседы выгружаются видео
4. Установите `python3.10`
5. Установите зависимости
    1. Я использую pipenv (возможно, вам понадобится дополнительно установить `python3.10-distutils`)
         ```
         pip install pipenv
         pipenv install
         pipenv shell  # Чтобы войти в virtualenv
         ```
    2. Но вы можете использовать чистый pip: `pip install -r requirements.txt`

### 1. Логин через приложение

1. В вк `python main.py login vk`. Ваша сессия истечёт через 24 часа.

   (можете добавить опцию `--with-login`, если хотите ввести логин и пароль, а не получить access token напрямую)

2. В telegram `python main.py login tg`. Тут сессия по времени не ограничена.

### 2. Экспорт сообщений из вк

1. Выберите беседу, откройте её в браузере и запомните её id
    * Для личного сообщения (**они пока не поддерживаются**) вы увидите что-то вроде `https://vk.com/im?sel=187654321`.
      Id беседы &mdash; 187654321
    * Для группового чата вы увидите что-то вроде `https://vk.com/im?sel=c142`. Id беседы &mdash; 2000000142 (нужно
      прибавить 2'000'000'000)
2. Экспортируйте сообщения `python main.py export --chat ID`. Можете добавить опцию `-n N`, чтобы выгрузить только
   последние N сообщений

### 3. Подготовка контактов

Чтобы telegram корректно отображал авторов сообщений в перенесённой беседе, нужно подготовить файл с контактами.
При желании можете пропустить этот этап.

1. `python main.py contacts prepare` создаст файл с соответствием имя пользователя в vk &mdash; имя пользователя в вашей
   контактной книге в telegram
2. Откройте сгенерированный файл и для всех пользователей введите имя `tg_name` так, как оно записано в ваших контактах.
   Если хотите пропустить маппинг для
   какого-то из пользователей, можете вместо имени ввести `""`. Тогда в качестве имени будет использоваться `vk_name`

    * Вы можете посмотреть все свои контакты, запустив `python main.py contacts list`
    * Если пользователя у вас в контактах нет, то телеграм не сможет сопоставить его сообщения с реальным аккаунтом
    * Даже если пользователь есть в контактах, нет гарантии, что телеграм справится и сможет сопоставить аккаунты

3. `python main.py contacts check` Проверьте, что вы нигде не ошиблись, и введённые вами имена присутствуют в ваших
   контактах

4. При желании можете создать тестовую беседу и проверить, как telegram сопоставляет пользователей.

   `python main.py utils test-contacts`

   Вместо имени пользователя вы должны увидеть его номер телефона. Теперь, если вы добавите этого пользователя в беседу,
   то номер телефона пропадёт, а сообщение станет выглядеть так, будто бы его отправил этот пользователь.

### 4. Загрузка медиа и конвертация vk-сообщений в tg-сообщения

Самый долгий этап, потому что видео выгружаются медленно.

`python main.py convert`

Можете добавить опцию `--skip-contacts`, если вы не хотите использовать маппинг контактов с прошлого шага.

### 5. Импорт сообщений в telegram

Рекомендую сначала создать супергруппу и добавить туда всех участников, и только потом начинать импорт.
Иначе телеграм сопоставит с реальными авторами только по 100 последних сообщений для каждого человека, а у более
старых сообщений вместо имени сопоставленного пользователя будет его номер телефона.

* Если вы хотите импортировать сообщения в уже существующий чат

  `python main.py import --chat ID`

  ID всех чатов можно посмотреть, запустив `python main.py utils list-chats`. Полезно понимать, что полученные ID
  не совсем настоящие: библиотека pyrogram модифицирует их
  и [приводит к своему формату](https://docs.pyrogram.org/topics/advanced-usage?highlight=For+example#chat-ids), поэтому
  использовать эти ID где-либо ещё, кроме этого приложения, напрямую не получится.

* Если вы хотите создать новую супергруппу и тут же импортировать в неё все сообщения

  `python main.py import --name 'имя нового чата'`
